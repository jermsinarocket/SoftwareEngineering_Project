<html lang="en">
  <head>
    {% load static %}
    {% load cloudinary %}
    <title>Enso</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="{% static 'images/icons/favicon.ico' %}" />
    <link rel="stylesheet" type="text/css" href="{% static "css/util.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "css/main.css" %}">
    <!--<link rel="stylesheet" type="text/css" href="{% static "vendor/Semantic-UI/semantic.min.css" %}"> -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="{% static "vendor/Applozic/public/plugin/css/app/sidebox/applozic.combined.min.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "vendor/Applozic/public/plugin/css/app/sidebox/applozic.sidebox.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "vendor/Applozic/public/plugin/css/app/sidebox/viewer.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "vendor/topper/topper.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "fonts/font-awesome-4.7.0/css/font-awesome.min.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "vendor/css-hamburgers/hamburgers.min.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "vendor/animsition/css/animsition.min.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "fonts/Linearicons-Free-v1.0.0/icon-font.min.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "vendor/Customizable-Badges/jquery.badge.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "vendor/Loading-Mask/app.min.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "vendor/an-skill-bar/an-skill-bar.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "vendor/imgcheckbox/animation.imgcheckbox.min.css" %}">
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" type="text/css" href="{% static "vendor/validate-password-requirements/jquery.passwordRequirements.css" %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="{% static "vendor/an-skill-bar/an-skill-bar.js" %}"></script>
    <script src="{% static "vendor/validate-password-requirements/jquery.passwordRequirements.js" %}"></script>
    <script src="{% static "vendor/rater/rater.min.js" %}"></script>
    <script src="{% static "vendor/imgcheckbox/jquery.imgcheckbox.min.js" %}"></script>
    <script src="{% static "vendor/Semantic-UI/semantic.min.js" %}"></script>

    <script src="{% static "vendor/Applozic/public/plugin/js/jquery.min.js" %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js"></script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyDDCVt_rTIk3xHjMY5OTtKb7TvEzPqOD4U"></script>
    <script src="{% static "vendor/bootstrap/js/popper.js" %}"></script>
    <script src="{% static "vendor/bootstrap/js/bootstrap-input-spinner.js" %}"></script>
    <script src="{% static "vendor/bootstrap/js/bootstrap.min.js" %}"></script>
    <script src="{% static "vendor/topper/topper.js" %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
    <script src="https://unpkg.com/boxicons@latest/dist/boxicons.js"></script>
    <script src="{% static "vendor/Customizable-Badges/jquery.badge.js" %}"></script>

    <link rel="stylesheet" type="text/css" href="{% static "vendor/bootstrap/css/bootstrap.min.css" %}">
    <link href="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/a549aa8780dbda16f6cff545aeabc3d71073911e/build/css/bootstrap-datetimepicker.css" rel="stylesheet"/>


    <script>
      $(document).ready(function() {
        $('.pop-up-tooltip').popup({transition:'Fade Up'});
        $('.skillbar').skillbar({
          speed: 4000
        });
        var target_id = 'upcoming_gatherings'
        if(window.location.search.split('?')[1]){
          target_id = window.location.search.split('?')[1]
        }

        loadMainContentContainer(target_id)
        $(".pr-password").passwordRequirements({
          numCharacters: 8,
          useLowercase: true,
          useUppercase: true,
          useNumbers: true,
          useSpecial: true
        });

      });

      function loadMainContentContainer(target_id){
        $('#menu-content').empty()
        $("#sub-menu").children(".active").removeClass("active");
        $("#" + target_id).addClass("active");

       eval(target_id + '();');

      }

      function upcoming_gatherings(){
          var main_content_container = document.getElementById("menu-content")
          var main_content_container_innerHTML = ""
          {% for user_gathering in upcoming_gatherings %}
            main_content_container_innerHTML += '<div class="row ui horizontal card" style="width:900">' +
                                                  '<div class="image">' +
                                                    '<img src="{{user_gathering.gathering.food_store.get_storepic_url}}">' +
                                                  '</div>' +
                                                  '<div class="content">' +
                                                    '<div class="row">' +
                                                      '<div class="col-6">'+
                                                        '<div class="header"><span class="fs-20">{{user_gathering.gathering.name}}</span><span class="card-text fs-18 " onclick="chat({{user_gathering.gathering.chat_id}})" style="cursor:pointer;padding-left:10;"><i class="pop-up-tooltip bx bxs-chat bx-border bx-tada-hover bx-sm"></i></div>' +
                                                        '<div class="meta">' +
                                                          '<span class="category">You are a <span class="bold">{{user_gathering.get_member_type_display}}</span></span>' +
                                                        '</div>' +
                                                      '</div>'

            {% for member in user_gathering.gathering.user_gathering.all %}

             if('{{member.status}}' === "J"){
                main_content_container_innerHTML += "<div class='col-sm-1' >" +
                                                        "<img class='avatar-tooltip' data-content='{{member.user_profile.first_name}} ({{member.get_member_type_display}})' src='{{member.user_profile.get_profile_url}}' style='width:45;border-radius:50%;border:2px solid green;cursor:pointer;' onclick='chatIndiv({{member.user_profile.id}})'></img>" +
                                                      "</div>"
             }
             {% endfor %}

             for (i = 0; i < {{user_gathering.gathering.getRemainingPax}}; i++) {
                main_content_container_innerHTML +=   "<div class='col-sm-1'>" +
                                                          "<img class='avatar-tooltip' data-content='Invite Someone!' src='https://bethanychurch.org.uk/wp-content/uploads/2018/09/profile-icon-png-black-6.png' style='width:45;border-radius:50%;border:2px solid grey;cursor:pointer;'></img>" +
                                                        "</div>"

              }

            main_content_container_innerHTML +=       '</div>' +
                                                    '<div class="description">' +
                                                      '<div class="row" style="margin-top:5;">' +
                                                        '<div class="col">' +
                                                          '<p class="card-text">Where?</p>' +
                                                          '<p class="card-text bold" style="margin-top:-8">{{user_gathering.gathering.food_store.store_name}} </p>'+
                                                          '<p class="card-text bold" style="margin-top:-9">#{{user_gathering.gathering.food_store.unit_number}},&nbsp;{{user_gathering.gathering.food_store.hawker_centre.zip_code.address}} </p>'+
                                                        '</div>' +
                                                        '<div class="col">'+
                                                          '<p class="card-text">When?</p>' +
                                                          '<p class="card-text bold" style="margin-top:-8">{{user_gathering.gathering.date}}, {{user_gathering.gathering.start_time}}</p>'+
                                                        '</div>' +
                                                      '</div>'+
                                                      {% if user_gathering.member_type == 'H'%}
                                                        "<div class='ui inverted green button' style='margin-top:8'onclick='window.location.href={% url 'gathering_page' %}'>Manage</div>" +
                                                      {% endif %}
                                                    '</div>' +
                                                  '</div>' +
                                                '</div>'
          {% endfor %}

          main_content_container.innerHTML += main_content_container_innerHTML
          $('.avatar-tooltip').popup();
      }

      function pending_complete_gatherings(){
        var main_content_container = document.getElementById("menu-content")
        var main_content_container_innerHTML = ""
        {% for user_gathering in pending_complete_gatherings %}
          main_content_container_innerHTML += '<div class="row ui horizontal card" style="width:900">' +
                                                '<div class="image">' +
                                                    '<div class="ui red ribbon label">' +
                                                      'Pending'+
                                                    '</div>'+
                                                  '<img src="{{user_gathering.gathering.food_store.get_storepic_url}}">' +
                                                '</div>' +
                                                '<div class="content">' +
                                                  '<div class="row">' +
                                                    '<div class="col-6">'+
                                                      '<div class="header"><span class="fs-20">{{user_gathering.gathering.name}}</span><span class="card-text fs-18 " onclick="chat({{user_gathering.gathering.chat_id}})" style="cursor:pointer;padding-left:10;"><i class="pop-up-tooltip bx bxs-chat bx-border bx-tada-hover bx-sm"></i></div>' +
                                                      '<div class="meta">' +
                                                        '<span class="category">You are a <span class="bold">{{user_gathering.get_member_type_display}}</span></span>' +
                                                      '</div>' +
                                                    '</div>'

          var host_id = 0;
          {% for member in user_gathering.gathering.user_gathering.all %}

           if('{{member.status}}' === "J"){
              main_content_container_innerHTML += "<div class='col-sm-1' >" +
                                                      "<img class='avatar-tooltip' data-content='{{member.user_profile.first_name}} ({{member.get_member_type_display}})' src='{{member.user_profile.get_profile_url}}' style='width:45;border-radius:50%;border:2px solid green;cursor:pointer;' onclick='chatIndiv({{member.user_profile.id}})'></img>" +
                                                    "</div>"
           }

           if('{{member.member_type}}' === "H"){
             host_id = {{member.user_profile.id}}
           }
           {% endfor %}

          main_content_container_innerHTML +=     '</div>' +
                                                  '<div class="description">' +
                                                    '<div class="row" style="margin-top:5;">' +
                                                      '<div class="col">' +
                                                        '<p class="card-text">Where?</p>' +
                                                        '<p class="card-text bold" style="margin-top:-8">{{user_gathering.gathering.food_store.store_name}} </p>'+
                                                        '<p class="card-text bold" style="margin-top:-9">#{{user_gathering.gathering.food_store.unit_number}},&nbsp;{{user_gathering.gathering.food_store.hawker_centre.zip_code.address}} </p>'+
                                                      '</div>' +
                                                      '<div class="col">'+
                                                        '<p class="card-text">When?</p>' +
                                                        '<p class="card-text bold" style="margin-top:-8">{{user_gathering.gathering.date}}, {{user_gathering.gathering.start_time}}</p>'+
                                                      '</div>' +
                                                    '</div>'+
                                                    {% if user_gathering.member_type == 'H'%}
                                                      '<span class="ui inverted green button" data-toggle="modal" data-target="#manageCompletionModal" data-whichever="{{user_gathering.gathering.name}}" data-whatever="{{user_gathering.gathering.id}}" style="margin-top:8">Mark as Completed</span>' +
                                                      {% else %}
                                                      '<span class="ui inverted green button" onclick="sendMessage(this)" data-whatever="'+ host_id +'" data-whichever="{{user_gathering.gathering.name}}" style="margin-top:8">Remind Host</span>' +
                                                    {% endif %}
                                                  '</div>' +
                                                '</div>' +
                                              '</div>'
        {% endfor %}

        {% for user_gathering in completed_gatherings %}
          main_content_container_innerHTML += '<div class="row ui horizontal card" style="width:900">' +
                                                '<div class="image">' +
                                                    '<div class="ui {% if user_gathering.rating %}green{% else %}orange {% endif %} ribbon label">' +
                                                      {% if user_gathering.rating %}'Completed'{% else %}'To Review'{% endif %}+
                                                    '</div>'+
                                                  '<img src="{{user_gathering.gathering.food_store.get_storepic_url}}">' +
                                                '</div>' +
                                                '<div class="content">' +
                                                  '<div class="row">' +
                                                    '<div class="col-6">'+
                                                      '<div class="header"><span class="fs-20">{{user_gathering.gathering.name}}</span><span class="card-text fs-18 " onclick="chat({{user_gathering.gathering.chat_id}})" style="cursor:pointer;padding-left:10;"><i class="pop-up-tooltip bx bxs-chat bx-border bx-tada-hover bx-sm"></i></span>'+
                                                       '<a class="card-text fs-18" href="{{user_gathering.gathering.get_receipt_url}}" target="_blank" style="color:black;cursor:pointer;padding-left:10;"><i class="pop-up-tooltip bx bxs-receipt bx-border bx-tada-hover bx-sm"></i></a></div>' +
                                                      '<div class="meta">' +
                                                        '<span class="category">You are a <span class="bold">{{user_gathering.get_member_type_display}}</span></span>' +
                                                      '</div>' +
                                                    '</div>'

            {% for member in user_gathering.gathering.user_gathering.all %}

             if('{{member.status}}' === "J"){
                main_content_container_innerHTML += "<div class='col-sm-1' >" +
                                                        "<img class='avatar-tooltip' data-content='{{member.user_profile.first_name}} ({{member.get_member_type_display}})' src='{{member.user_profile.get_profile_url}}' style='width:45;border-radius:50%;border:2px solid green;cursor:pointer;' onclick='chatIndiv({{member.user_profile.id}})'></img>" +
                                                      "</div>"
             }
             {% endfor %}

          main_content_container_innerHTML +=     '</div>' +
                                                  '<div class="description">' +
                                                    '<div class="row" style="margin-top:5;">' +
                                                      '<div class="col">' +
                                                        '<p class="card-text">Where?</p>' +
                                                        '<p class="card-text bold" style="margin-top:-8">{{user_gathering.gathering.food_store.store_name}} </p>'+
                                                        '<p class="card-text bold" style="margin-top:-9">#{{user_gathering.gathering.food_store.unit_number}},&nbsp;{{user_gathering.gathering.food_store.hawker_centre.zip_code.address}} </p>'+
                                                      '</div>' +
                                                      '<div class="col">'+
                                                        '<p class="card-text">When?</p>' +
                                                        '<p class="card-text bold" style="margin-top:-8">{{user_gathering.gathering.date}}, {{user_gathering.gathering.start_time}}</p>'+
                                                      '</div>' +
                                                    '</div>' +

                                                    {% if user_gathering.rating %}
                                                       '<div class="row" style="margin-top:5;"><span class="fs-14 m-l-15">You Rated:&nbsp;</span> '+
                                                      {% for i in "12345" %}
                                                        {% if forloop.counter <= user_gathering.rating.rating %}
                                                          "<i class='fa fa-star' style='color:#ffe108; font-size:16px'></i>" +
                                                        {% else %}
                                                          "<i class='fa fa-star' style='font-size:18px'></i>" +
                                                        {% endif %}
                                                      {% endfor %}
                                                      '</div>' +
                                                      {% else %}
                                                      '<div class="ui inverted orange button" style="margin-top:8" data-toggle="modal" data-target="#manageReviewModal" data-whichever="{{user_gathering.gathering.food_store.id}}" data-whenever="{{user_gathering.gathering.food_store.store_name}}" data-whatever="{{user_gathering.id}}">Leave a Review</div>' +
                                                    {% endif %}
                                                 '</div>' +
                                                '</div>' +
                                              '</div>'


        {% endfor %}

        main_content_container.innerHTML += main_content_container_innerHTML
        $('.avatar-tooltip').popup();

      }

      function reviews(){
        var main_content_container = document.getElementById("menu-content")
        var main_content_container_innerHTML = ""
        {% for user_gathering in reviews %}
          main_content_container_innerHTML += '<div class="row ui horizontal card" style="width:900">' +
                                                '<div class="image">' +
                                                    '<div class="ui orange ribbon label">' +
                                                    'To Review'+
                                                    '</div>'+
                                                  '<img src="{{user_gathering.gathering.food_store.get_storepic_url}}">' +
                                                '</div>' +
                                                '<div class="content">' +
                                                  '<div class="row">' +
                                                    '<div class="col-6">'+
                                                      '<div class="header"><span class="fs-20">{{user_gathering.gathering.name}}</span><span class="card-text fs-18 " onclick="chat({{user_gathering.gathering.chat_id}})" style="cursor:pointer;padding-left:10;"><i class="pop-up-tooltip bx bxs-chat bx-border bx-tada-hover bx-sm"></i></span>'+
                                                       '<a class="card-text fs-18" href="{{user_gathering.gathering.get_receipt_url}}" target="_blank" style="color:black;cursor:pointer;padding-left:10;"><i class="pop-up-tooltip bx bxs-receipt bx-border bx-tada-hover bx-sm"></i></a></div>' +
                                                      '<div class="meta">' +
                                                        '<span class="category">You are a <span class="bold">{{user_gathering.get_member_type_display}}</span></span>' +
                                                      '</div>' +
                                                    '</div>'

            {% for member in user_gathering.gathering.user_gathering.all %}

             if('{{member.status}}' === "J"){
                main_content_container_innerHTML += "<div class='col-sm-1' >" +
                                                        "<img class='avatar-tooltip' data-content='{{member.user_profile.first_name}} ({{member.get_member_type_display}})' src='{{member.user_profile.get_profile_url}}' style='width:45;border-radius:50%;border:2px solid green;cursor:pointer;' onclick='chatIndiv({{member.user_profile.id}})'></img>" +
                                                      "</div>"
             }
             {% endfor %}

          main_content_container_innerHTML +=     '</div>' +
                                                  '<div class="description">' +
                                                    '<div class="row" style="margin-top:5;">' +
                                                      '<div class="col">' +
                                                        '<p class="card-text">Where?</p>' +
                                                        '<p class="card-text bold" style="margin-top:-8">{{user_gathering.gathering.food_store.store_name}} </p>'+
                                                        '<p class="card-text bold" style="margin-top:-9">#{{user_gathering.gathering.food_store.unit_number}},&nbsp;{{user_gathering.gathering.food_store.hawker_centre.zip_code.address}} </p>'+
                                                      '</div>' +
                                                      '<div class="col">'+
                                                        '<p class="card-text">When?</p>' +
                                                        '<p class="card-text bold" style="margin-top:-8">{{user_gathering.gathering.date}}, {{user_gathering.gathering.start_time}}</p>'+
                                                      '</div>' +
                                                    '</div>' +
                                                    '<div class="ui inverted orange button" style="margin-top:8" data-toggle="modal" data-target="#manageReviewModal" data-whichever="{{user_gathering.gathering.food_store.id}}" data-whenever="{{user_gathering.gathering.food_store.store_name}}" data-whatever="{{user_gathering.id}}">Leave a Review</div>' +
                                                 '</div>' +
                                                '</div>' +
                                              '</div>'
        {% endfor %}


      main_content_container.innerHTML += main_content_container_innerHTML
      $('.avatar-tooltip').popup();
      }

      $(document).on('show.bs.modal','#manageReviewModal', function (event) {
        var button = $(event.relatedTarget)
        var user_gathering_id = parseInt(button.data('whatever'))
        var store_name = button.data('whenever')
        var foodstore_id = parseInt(button.data('whichever'))

        var manage_review_container = document.getElementById("manage_review_body")
        $("#manageReviewModalLabel").text("How was your experience at " + store_name + "?");

            var manage_review_body_innerHTML = "<form class='container ui form' id='manageReviewForm'>" +
                                                  "<div class='field' style='text-align:center'><label style='font-size:15'>Give a Rating</label></div>" +
                                                  "<div class='row justify-content-center' style='margin-top:-15'><div class='rating' data-rate-value=3 style='width:146px;height:47;font-size:35'></div></div>" +
                                                  "<div class='row field justify-content-center' style='text-align:center;margin-top:5'><label style='font-size:15'>Leave a Review</label></div>" +
                                                    "<div class='field'>" +
                                                     "<textarea id='reviewText' rows='2' style='1px solid rgba(34,36,38,.15)' required></textarea>" +
                                                   "</div>" +
                                                  '<div class="row justify-content-center" style="padding-top:10"><button class="ui primary button">Submit Review</button></div>' +
                                               '</form>'


        manage_review_container.innerHTML = manage_review_body_innerHTML

        var options = {
            max_value: 5,
            initial_value: 3,
            additional_data: {'user_gathering_id':user_gathering_id,'foodstore_id':foodstore_id},
            step_size: 1,
        }

        $(".rating").rate(options);
      });

      $(document).on('submit', '#manageReviewForm',function(event){
        event.preventDefault();
        var data = $(".rating").rate("getAdditionalData")
        data['rating'] =  $(".rating").rate('getValue')
        data['review'] = $('textarea').val()

        $.ajax({
            type : "POST",
            url: '{% url "create_review" %}',
            data : data,
            success : function(json) {
                Topper({
                  title: '',
                  text: 'Review has been submitted!',
                  style: 'success',
                  type: 'top',
                  autoclose: true,
                  autocloseAfter: 3000
                });

                window.location.href = "?pending_complete_gatherings";
            },
            // handle a non-successful response
            error : function(xhr,errmsg,err) {
              console.log(errmsg)
            }
      });

      });

      $(document).on('show.bs.modal','#manageCompletionModal', function (event) {
        var button = $(event.relatedTarget)
        var gathering_id = parseInt(button.data('whatever'))

        var gathering_name = button.data('whichever')
        var manage_completion_container = document.getElementById("manage_completion_body")
        $("#manageCompletionModalLabel").text("Reviewing: " + gathering_name);
        manage_completion_container.innerHTML = ""
        var manage_completion_body_innerHTML = "<form class='ui form' id='manageSubmitForm'>" +
                                                 "<div class='field'><label style='font-size:15;padding-left:15;'>Confirm Attendees<br><span id='confirmed_participants_error' class='italic dis-none' style='font-size:12;color:red'> Participants must be selected </span></label></div><div class='row'>"

        {% for user_gathering in pending_complete_gatherings %}
          if({{user_gathering.gathering.id}} === gathering_id){
            {% for member in user_gathering.gathering.user_gathering.all %}
            manage_completion_body_innerHTML += '<div class="col-sm-2" style="margin-left:10!important;"><label class="image-checkbox" style="border-radius:50%" title="{{member.user_profile.first_name}}">'  +
                                                    '<img class="avatar-tooltip" data-content="{{member.user_profile.first_name}}" style="width:70;height:60;border-radius:50%" src="{{member.user_profile.get_profile_url}}" />'  +
                                                    '<input type="checkbox" name="confirmed_participants" value="{{member.id}}" />'  +
                                                '</label></div>'
            {% endfor %}
          }
        {% endfor %}

          manage_completion_body_innerHTML +=   '</div>' +
                                                  '<div class="field" style="padding-top:5"><label style="font-size:15;padding-left:15">Upload Receipt<br><span id="receipt_file_error" class="italic dis-none" style="font-size:12;color:red"> Receipt is required</span></label></div>'  +
                                                    '<div class="ui action input" style="padding-left:15">' +
                                                    '<input type="text" placeholder="Receipt..." readonly>' +
                                                    '<input id="receipt_upload" type="file" style="display:none">' +
                                                    '<div class="ui icon button">' +
                                                      '<i class="attach icon"></i>' +
                                                    '</div>' +
                                                  '</div>' +
                                                  '<div class="row" style="padding-left:30;padding-top:20"><button class="ui primary button">Confirm</button></div>' +
                                                  "</form>"


        manage_completion_container.innerHTML = manage_completion_body_innerHTML
        $('.avatar-tooltip').popup();

        $("input:text").click(function() {
            $(this).parent().find("input:file").click();
          });

          $('input:file', '.ui.action.input')
            .on('change', function(e) {
              var name = e.target.files[0].name;
              $('input:text', $(e.target).parent()).val(name);
            });

        $(".image-checkbox").each(function () {
            if ($(this).find('input[type="checkbox"]').first().attr("checked")) {
                $(this).addClass('image-checkbox-checked');
            }
            else {
                $(this).removeClass('image-checkbox-checked');
            }
        });

        // sync the state to the input
        $(".image-checkbox").on("click", function (e) {
            if ($(this).hasClass('image-checkbox-checked')) {
                $(this).removeClass('image-checkbox-checked');
                $(this).find('input[type="checkbox"]').first().removeAttr("checked");
            }
            else {
                $(this).addClass('image-checkbox-checked');
                $(this).find('input[type="checkbox"]').first().attr("checked", "checked");
            }

            e.preventDefault();
        });

        $(document).on('submit', '#manageSubmitForm',function(event){
        		event.preventDefault()
            var confirmed_participants = [];
            var absent_participants = [];
            $("input:checkbox[name=confirmed_participants]:checked").each(function(){
                confirmed_participants.push($(this).val());
                console.log(confirmed_participants)
            });

            $("input:checkbox[name=confirmed_participants]:not(:checked)").each(function(){
                absent_participants.push($(this).val());
            });
            var formValid = true;
            if(confirmed_participants.length == 0){
              $('#confirmed_participants_error').removeClass("dis-none")
              formValid = false;
            }else{
              $('#confirmed_participants_error').addClass("dis-none")
            }

            if ($('#receipt_upload').get(0).files.length === 0) {
                $('#receipt_file_error').removeClass("dis-none")
                formValid = false;
            }else{
                $('#receipt_file_error').addClass("dis-none")
            }


            if(formValid){
              var data = new FormData($('#manageSubmitForm')[0])
              data.append('confirmed_participants',confirmed_participants);
              data.append('absent_participants',absent_participants);
              data.append('file', $("input[type=file]").get(0).files[0]);
              data.append('gathering_id',gathering_id );

              $.ajax({
                  type : "POST",
                  url: '{% url "complete_gathering" %}',
                  data : data,
                  contentType: false,
                  processData: false,
                  success : function(json) {
                      sendMessageCustom(json['chat_id'], "Thank you for attending the gathering!!!")
                      Topper({
                        title: '',
                        text: 'Gathering has been completed!',
                        style: 'success',
                        type: 'top',
                        autoclose: true,
                        autocloseAfter: 3000
                      });

                      window.location.href = "?pending_complete_gatherings";
                  },
                  // handle a non-successful response
                  error : function(xhr,errmsg,err) {
                    console.log(errmsg)
                  }
            });
            }

        });


      });

    </script>
  </head>
  <body>
    <div class="container p-t-10">
      <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <a class="navbar-brand" href="{% url 'homepage' %}">
          <img src="{% static 'images/logo.png' %}" style="width:49px;" alt="Enso">
        </a>
        <button class="navbar-toggler ml-auto " type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNavDropdown">
          <ul class="navbar-nav">
            <li class="nav-item" style="text-align:right;">
              <a class="nav-link fs-20" href="{% url 'gathering_page' %}"><i class='pop-up-tooltip bx bxs-group bx-border bx-tada-hover bx-sm' data-content="Manage your Gatherings"></i></a>
            </li>
            <li class="nav-item dropdown"  style="text-align:right;">
              <a id="profile-pic-icon" class="nav-link" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <img src="{{ user.profile.get_profile_url }}" style="width:35px;height:35px;border-radius:20%"></img>
              </a>
              <div class="dropdown-menu slideIn  animate ml-auto" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="#" style="padding:.25rem 1rem !important;">
                    <i class="fa fa-lg fa-user"></i><span style="color:#db2828!important">  View Profile</span>
                  </a>
                  <a class="dropdown-item" href="{% url 'logout_user' %}" style="padding:.25rem 1rem !important;">
                    <i class="fa fa-lg fa-sign-out"></i>  Log Out
                  </a>
              </div>
            </li>
          </ul>
        </div>
      </nav>
    </div>
    <div class="row section-divider"></div>
    <div class="container">
      <div class="row">
          <div class="col-3">
            <div class="row">
              <div class="ui card">
                <div class="image">
                  <img src="{{user.profile.get_profile_url}}">
                </div>
                <div class="content">
                  <span class="header">{{user.profile.first_name}}
                    <span class="card-text fs-18" data-toggle="modal" data-target="#editProfileModal"style="cursor:pointer;padding-left:10;"><i class="pop-up-tooltip bx bxs-edit bx-border bx-tada-hover bx-sm" data-content="Edit Profile"></i></span>
                    <span class="card-text fs-18" data-toggle="modal" data-target="#changePasswordModal"style="cursor:pointer;padding-left:10;"><i class="pop-up-tooltip fa fa-unlock-alt bx-border bx-tada-hover bx-sm" data-content="Change Password"></i></span>
                  </span>
                  <div class="meta">
                    <span class="date">Member since {{user.profile.get_date_joined}}</span>
                    <div class="skillbar">
                      <div class="filled" data-width="{{user.profile.get_level_percent}}%" style="background-color:#cf7aa4"></div>
                      <span class="title">Level {{user.profile.current_level.id}}</span>
                      <span class="percent">EXP {{user.profile.points}}/{{user.profile.current_level.max_points}}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </div>
        <div class='col-9' style='margin-bottom:15px !important'>
          <div class="row" style='margin-left:10 !important;'>
            <div class="ui fluid three item menu" id="sub-menu">
              <a id="upcoming_gatherings" class="item active" onclick="loadMainContentContainer('upcoming_gatherings');">Upcoming Gatherings&nbsp;<span class='bold'> {% if upcoming_gatherings|length > 0 %}({{upcoming_gatherings|length}}){% endif %}</span></a>
              <a id="pending_complete_gatherings" class="item" onclick="loadMainContentContainer('pending_complete_gatherings');">Completed Gatherings&nbsp;<span class='bold'>{% if pending_complete_gatherings|length > 0 %}({{pending_complete_gatherings|length}}){% endif %}</span></a>
              <a id="reviews" class="item" onclick="loadMainContentContainer('reviews');" >To Review&nbsp;<span class='bold'>{% if reviews|length > 0 %}({{reviews|length}}){% endif %}</a>
            </div>
          </div>
          <div id="menu-content" class="container" style="margin-left:10 !important;margin-top:15 !important;">
          </div>
        </div>
      </div>
    </div>
    <span id="chat-unread-count" class="chat-launcher-icon" ></span>
    <div class="modal fade" id="manageCompletionModal" tabindex="-1" role="dialog" aria-labelledby="manageCompletionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered"  role="document">
        <div class="modal-content" style="width:400;">
          <div class="modal-header">
            <h5 class="modal-title" style="margin:auto;" id="manageCompletionModalLabel"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="manage_completion_body">
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="manageReviewModal" tabindex="-1" role="dialog" aria-labelledby="manageReviewModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered"  role="document">
        <div class="modal-content" style="width:450;">
          <div class="modal-header">
            <h5 class="modal-title" style="margin:auto;" id="manageReviewModalLabel"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="manage_review_body">
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="changePasswordModal" tabindex="-1" role="dialog" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered"  role="document">
        <div class="modal-content" style="width:450;">
          <div class="modal-header">
            <h5 class="modal-title" style="margin:auto;" id="changePasswordModalLabel">Change Password</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="close_password_form">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="change_password_body">
            <div class="ui form" id="change_password_form">
              <div class="ui error message" id="change_password_error">
                <p>Passwords do not match</p>
              </div>
              <div class="field">
                <label>New Password</label>
                <input class="pr-password" id="change_password_first" type="password" required>
              </div>
              <div class="field">
                <label>Re-enter Password</label>
                <input type="password" id="change_password_second" required>
              </div>
              <div class="ui primary button" onclick="changePassword();">Change Password</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="editProfileModal" tabindex="-1" role="dialog" aria-labelledby="editProfileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered"  role="document">
        <div class="modal-content" style="width:450;">
          <div class="modal-header">
            <h5 class="modal-title" style="margin:auto;" id="editProfileModalLabel">Edit Profile</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="edit_profile_form">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="edit_profile_body">
            <div class="ui form">
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
    $("#profile-pic-icon").badge({{user.profile.current_level.id}},'bottom')

    function changePassword(){
      if($('#change_password_first').val() != $('#change_password_second').val()){
        $('#change_password_error').addClass('dis-block')
      }else{
        $('#change_password_error').removeClass('dis-block')

        $.ajax({
            type : "POST",
            url: '{% url "change_password" %}',
            data : {'password':$('#change_password_first').val()},
            success : function(json) {
                Topper({
                  title: '',
                  text: 'Password has been successfully changed!',
                  style: 'success',
                  type: 'top',
                  autoclose: true,
                  autocloseAfter: 3000
                });

                $('#close_password_form').trigger('click')

            },
            // handle a non-successful response
            error : function(xhr,errmsg,err) {
              console.log(errmsg)
            }
      });
      }
    }
    </script>

    <script src="{% static "vendor/Applozic/public/plugin/js/app/modules/applozic.jquery.js" %}"></script>
    <script type="text/javascript" src="https://cdn.applozic.com/applozic/applozic.chat-6.1.min.js"></script>
    <script src="{% static "vendor/Applozic/public/plugin/js/app/sidebox/applozic.sidebox.js" %}"></script>

    <script>
    (function(d, m){var s, h;
       s = document.createElement("script");
       s.type = "text/javascript";
       s.async=true;
       s.src="https://apps.applozic.com/sidebox.app";
       h=document.getElementsByTagName('head')[0];
       h.appendChild(s);
       window.applozic=m;
       m.init=function(t){m._globals=t;}})(document, window.applozic || {});
    </script>

    <script type="text/javascript">

      window.applozic.init({
        appId: '3078042d7c9d5ae7b2abd9029b0054991',      //Get your App ID from https://www.applozic.com
        userId: {{user.profile.id}},                     //Logged in user's id, a unique identifier for user
        userName: '{{user.profile.first_name}}',                 //User's display name
        imageLink : '{{user.profile.ge1t_profile_url}}',                     //User's profile picture url
        desktopNotification: true,
        source: '5',                          // optional, WEB(1),DESKTOP_BROWSER(5), MOBILE_BROWSER(6)
        notificationIconLink: "{% static 'images/icons/favicon.ico' %}",    //Icon to show in desktop notification, replace with your icon
        notificationSoundLink :"{% static 'vendor/Applozic/public/plugin/audio/notification_tone.mp3' %}",
        authenticationTypeId: 1,          //1 for password verification from Applozic server and 0 for access Token verification from your server
        accessToken: '',                    //optional, leave it blank for testing purpose, read this if you want to add additional security by verifying password from your server https://www.applozic.com/docs/configuration.html#access-token-url
        locShare: true,
        googleMapScriptLoaded : true,   // true if your app already loaded google maps script
        autoTypeSearchEnabled : true,     // set to false if you don't want to allow sending message to user who is not in the contact list
        loadOwnContacts : false, //set to true if you want to populate your own contact list,
        topicBox:true,
        disableSelfChat:true,
        groupUserCount: true,
        onInit : function(response) {
            if (response === "success") {
               console.log('login successful, perform your actions if any, for example: load contacts, getting unread message count, etc')
               $("#mck-sidebox-launcher").prepend("<span id='unread-count' class='bold fs-16 dis-none' ></span>")
        }
      }
     });
    </script>

    <script src="{% static "vendor/Loading-Mask/app.js" %}"></script>

    <script>
    $("#chat-unread-count").on('DOMSubtreeModified', function () {
      var unread_count = $('#chat-unread-count').text()
      if(unread_count.length === 0){
        $("#unread-count").addClass('dis-none')
      }else{
        $("#unread-count").removeClass('dis-none')
        document.getElementById("unread-count").textContent = $('#chat-unread-count').text()
      }
    });


    function chatIndiv(id){
      $applozic.fn.applozic('loadTab', id);
    }

    function sendMessage(event){
      var button = $(event)
      $applozic.fn.applozic('sendMessage', {
                  'to': parseInt(button.data('whatever')),           // userId of the receiver
                  'message' : "Hello, please confirm the completion for " + button.data('whichever') + "!",
                  'type' : 0                  //(optional) DEFAULT(0),
                    });

    }

    function sendMessageCustom(groupID,message){
      $applozic.fn.applozic('sendGroupMessage',
          {'groupId' : groupID,
         'clientGroupId' : groupID,
         'message' : message
         });

    }



    function chat(groupID){
      $applozic.fn.applozic('loadGroupTab', groupID);
    }
    </script>

  </body>
</html>
